<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <title>Kernel – Flash cards</title>
  <link rel="icon" type="image/png" href="kernel_icon_round_32.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
</head>
<body id="flashcard-page">

  <div class="quick-actions">
    <a href="/cpge/" class="action-btn" title="Accueil">
      <span class="q-icon icon-home"></span>
    </a>
    <button id="theme-toggle" class="action-btn" title="Changer de thème">
      <span class="q-icon icon-theme"></span>
    </button>
  </div>

  <div id="app">
    <p class="flashcard-status" id="status-msg">Chargement du jeu de cartes…</p>
  </div>

  <script src="script.js"></script>
  <script>
  (function () {
    const params = new URLSearchParams(window.location.search);
    const deckParam = params.get('deck');

    if (!deckParam) {
      document.getElementById('status-msg').textContent = "Aucun jeu de cartes spécifié.";
      return;
    }

    let deck = [];
    let queue = [];
    let queueIndex = 0;
    let currentCard = null;
    let frontIsFormula = true;
    let flipped = false;

    let cardEl, frontContent, backContent, progressFill, progressLabel, dot0, dot1;

    function shuffleFY(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function renderMath(el) {
      if (window.renderMathInElement) {
        renderMathInElement(el, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\(', right: '\\)', display: false },
            { left: '\\[', right: '\\]', display: true }
          ],
          throwOnError: false
        });
      }
    }

    function buildUI(title) {
      document.title = `Kernel – ${title}`;
      const app = document.getElementById('app');
      app.innerHTML = '';

      const titleDiv = document.createElement('div');
      titleDiv.className = 'deck-title';
      titleDiv.innerHTML = `<h1>${title}</h1>`;
      app.appendChild(titleDiv);

      const progWrap = document.createElement('div');
      progWrap.className = 'progress-wrap';
      progWrap.innerHTML = `
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="prog-fill" style="width:0%"></div></div>
        <div class="progress-label" id="prog-label">0 / ${deck.length}</div>`;
      app.appendChild(progWrap);

      const scene = document.createElement('div');
      scene.className = 'scene';
      scene.innerHTML = `
        <div class="card" id="card">
          <div class="card-face front">
            <span class="card-label" id="front-label"></span>
            <div class="card-content" id="front-content"></div>
            <span class="card-hint">Appuyer pour retourner</span>
          </div>
          <div class="card-face back">
            <span class="card-label" id="back-label"></span>
            <div class="card-content" id="back-content"></div>
          </div>
        </div>`;
      app.appendChild(scene);

      const dots = document.createElement('div');
      dots.className = 'side-dots';
      dots.innerHTML = `<div class="side-dot active" id="dot0"></div><div class="side-dot" id="dot1"></div>`;
      app.appendChild(dots);

      const ctrl = document.createElement('div');
      ctrl.className = 'flashcard-controls';
      ctrl.innerHTML = `
        <button class="btn" id="btn-flip">Retourner</button>
        <button class="btn btn-primary" id="btn-next">Suivante →</button>`;
      app.appendChild(ctrl);

      cardEl        = document.getElementById('card');
      frontContent  = document.getElementById('front-content');
      backContent   = document.getElementById('back-content');
      progressFill  = document.getElementById('prog-fill');
      progressLabel = document.getElementById('prog-label');
      dot0          = document.getElementById('dot0');
      dot1          = document.getElementById('dot1');

      scene.addEventListener('click', flipCard);
      document.getElementById('btn-flip').addEventListener('click', flipCard);
      document.getElementById('btn-next').addEventListener('click', nextCard);

      document.addEventListener('keydown', e => {
        if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'ArrowDown') {
          e.preventDefault();
          flipCard();
        }
        if (e.code === 'ArrowRight' || e.code === 'Enter') {
          e.preventDefault();
          nextCard();
        }
      });
    }

    function showCard() {
      flipped = false;
      cardEl.classList.remove('flipped');
      frontIsFormula = Math.random() < 0.5;

      if (frontIsFormula) {
        document.getElementById('front-label').textContent = 'Formule';
        frontContent.textContent = `$${currentCard.formula}$`;
        document.getElementById('back-label').textContent = 'Nom';
        backContent.textContent = currentCard.name;
      } else {
        document.getElementById('front-label').textContent = 'Nom';
        frontContent.textContent = currentCard.name;
        document.getElementById('back-label').textContent = 'Formule';
        backContent.textContent = `$${currentCard.formula}$`;
      }

      requestAnimationFrame(() => {
        renderMath(frontContent);
        renderMath(backContent);
      });

      const pct = Math.round((queueIndex / deck.length) * 100);
      progressFill.style.width = pct + '%';
      progressLabel.textContent = `${queueIndex} / ${deck.length}`;

      dot0.classList.add('active');
      dot1.classList.remove('active');
    }

    function flipCard() {
      flipped = !flipped;
      cardEl.classList.toggle('flipped', flipped);
      dot0.classList.toggle('active', !flipped);
      dot1.classList.toggle('active', flipped);
    }

    function nextCard() {
      if (queueIndex >= queue.length) {
        queue = shuffleFY(deck);
        queueIndex = 0;
      }
      currentCard = queue[queueIndex++];
      showCard();
    }

    async function init() {
      try {
        const res = await fetch(`flashcards/${deckParam}.json`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.cards || data.cards.length === 0) throw new Error('Jeu vide.');

        deck  = data.cards;
        queue = shuffleFY(deck);
        queueIndex = 0;

        function tryStart() {
          if (window.renderMathInElement) {
            buildUI(data.title);
            nextCard();
          } else {
            setTimeout(tryStart, 50);
          }
        }
        tryStart();

      } catch (err) {
        document.getElementById('status-msg').textContent =
          `Impossible de charger le jeu « ${deckParam} ». (${err.message})`;
      }
    }

    init();
  })();
  </script>

</body>
</html>
